<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RKRC Race Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
		<img src="img/logo-v4.png" />
        <h1>Race Control</h1>
        <div class="settings">
            <label for="raceTime">Select Race Time (minutes): </label>
            <select id="raceTime">
				<option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5" selected>5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
            <button id="startRace" disabled>Start Race</button>
        </div>
        <div class="timer" id="timer">00:00</div>
        <div class="controls">
            <button id="yellowFlag" disabled>Yellow Flag</button>
            <button id="redFlag" disabled>Red Flag</button>
            <button id="restart" disabled>Restart</button>
        </div>
    </div>

   <!-- Audio elements for different events -->
<audio id="startSound" src="{{ url_for('static', filename='audio/start.mp3') }}" preload="auto"></audio>
<audio id="yellowOnSound" src="{{ url_for('static', filename='audio/yellow_on.mp3') }}" preload="auto"></audio>
<audio id="yellowOffSound" src="{{ url_for('static', filename='audio/yellow_off.mp3') }}" preload="auto"></audio>
<audio id="redOnSound" src="{{ url_for('static', filename='audio/red_on.mp3') }}" preload="auto"></audio>
<audio id="redOffSound" src="{{ url_for('static', filename='audio/red_off.mp3') }}" preload="auto"></audio>
<audio id="endSound" src="{{ url_for('static', filename='audio/end.mp3') }}" preload="auto"></audio>
<audio id="restartSound" src="{{ url_for('static', filename='audio/restart.mp3') }}" preload="auto"></audio>
<!-- New audio elements for each minute and 30 seconds -->
<audio id="9-minute" src="{{ url_for('static', filename='audio/9-minute.mp3') }}" preload="auto"></audio>
<audio id="8-minute" src="{{ url_for('static', filename='audio/8-minute.mp3') }}" preload="auto"></audio>
<audio id="7-minute" src="{{ url_for('static', filename='audio/7-minute.mp3') }}" preload="auto"></audio>
<audio id="6-minute" src="{{ url_for('static', filename='audio/6-minute.mp3') }}" preload="auto"></audio>
<audio id="5-minute" src="{{ url_for('static', filename='audio/5-minute.mp3') }}" preload="auto"></audio>
<audio id="4-minute" src="{{ url_for('static', filename='audio/4-minute.mp3') }}" preload="auto"></audio>
<audio id="3-minute" src="{{ url_for('static', filename='audio/3-minute.mp3') }}" preload="auto"></audio>
<audio id="2-minute" src="{{ url_for('static', filename='audio/2-minute.mp3') }}" preload="auto"></audio>
<audio id="1-minute" src="{{ url_for('static', filename='audio/1-minute.mp3') }}" preload="auto"></audio>
<audio id="30-seconds" src="{{ url_for('static', filename='audio/30-seconds.mp3') }}" preload="auto"></audio>
<!-- New audio elements for updated start sequence -->
<audio id="beepSound" src="{{ url_for('static', filename='audio/beep.mp3') }}" preload="auto"></audio>
<audio id="startBeepSound" src="{{ url_for('static', filename='audio/start-beep.mp3') }}" preload="auto"></audio>
<audio id="startEnginesSound" src="{{ url_for('static', filename='audio/start-engines.mp3') }}" preload="auto"></audio>

<script>
    const raceTimeSelect = document.getElementById('raceTime');
    const startRaceBtn = document.getElementById('startRace');
    const timerDisplay = document.getElementById('timer');
    const yellowFlagBtn = document.getElementById('yellowFlag');
    const redFlagBtn = document.getElementById('redFlag');
    const restartBtn = document.getElementById('restart');

    let totalSeconds = 0;
    let secondsLeft = 0;
    let timerInterval = null;
    let isRunning = false;
    let isYellowFlag = false;
    let isRedFlag = false;
    let lastMinutePlayed = -1;
    let hasPlayed30Seconds = false; // Track if 30-second sound has been played

    // Explicitly enable start button and time selector on page load
    startRaceBtn.disabled = false;
    raceTimeSelect.disabled = false; // Ensure time selector is enabled on load
    console.log("Script loaded, start button and time selector enabled!");

    // Function to update background color or pattern based on state
    function updateBackgroundColor() {
        // Remove checkerboard class by default to ensure it's only applied when race ends
        document.body.classList.remove('checkerboard');
        // Set background based on state
        if (!isRunning && secondsLeft <= 0) {
            // Race has ended, apply checkerboard pattern
            document.body.classList.add('checkerboard');
        } else if (isRedFlag) {
            document.body.style.backgroundColor = '#e74c3c'; // Red for Red Flag
        } else if (isYellowFlag) {
            document.body.style.backgroundColor = '#f1c40f'; // Yellow for Yellow Flag
        } else if (isRunning) {
            document.body.style.backgroundColor = '#2ecc71'; // Green for Race Running
        } else {
            document.body.style.backgroundColor = '#f0f0f0'; // Default gray when not running
        }
    }

    // Start race with updated sequence
startRaceBtn.addEventListener('click', () => {
    totalSeconds = parseInt(raceTimeSelect.value) * 60;
    secondsLeft = totalSeconds;
    updateTimerDisplay();
    raceTimeSelect.disabled = true; // Disable time selector when race starts
    startRaceBtn.disabled = true;
    yellowFlagBtn.disabled = false;
    redFlagBtn.disabled = false;
    restartBtn.disabled = false;

    // Step 0: Play start-engines.mp3 immediately on button click
    try {
        console.log("Playing start-engines sound immediately");
        document.getElementById('startEnginesSound').play().catch(e => console.error("Audio play error for start-engines:", e));
    } catch (e) {
        console.error("Start-engines sound failed:", e);
    }

    // Step 1: Wait 3 seconds before starting the beep sequence
    setTimeout(() => {
        // Step 2: Play beep.mp3 every 1.5 seconds for 4 times
        let beepCount = 0;
        const beepInterval = setInterval(() => {
            if (beepCount < 4) {
                try {
                    console.log(`Playing beep ${beepCount + 1}/4`);
                    document.getElementById('beepSound').play().catch(e => console.error("Audio play error for beep:", e));
                } catch (e) {
                    console.error("Beep sound failed:", e);
                }
                beepCount++;
            } else {
                clearInterval(beepInterval); // Stop after 4 beeps
                // Step 3: Wait random 2-4 seconds after last beep
                const randomFinalDelay = Math.floor(Math.random() * 2000) + 1000; // Random delay between 2000-4000ms (2-3 seconds)
                setTimeout(() => {
                    // Step 4: Play start-beep.mp3 and start the timer
                    try {
                        console.log("Playing start-beep and starting timer");
                        document.getElementById('startBeepSound').play().catch(e => console.error("Audio play error for start-beep:", e));
                    } catch (e) {
                        console.error("Start-beep sound failed:", e);
                    }
                    isRunning = true;
                    updateBackgroundColor(); // Update background when race starts
                    startTimer();
                }, randomFinalDelay);
            }
        }, 1500); // Beep every 1.5 seconds
    }, 3000); // Initial 3-second delay
});

    // Timer logic
    function startTimer() {
        timerInterval = setInterval(() => {
            if (isRunning && secondsLeft > 0) {
                secondsLeft--;
                updateTimerDisplay();
                checkTimeMarks(); // Check for minute and 30-second marks
            } else if (secondsLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                try {
                    document.getElementById('endSound').play().catch(e => console.error("Audio play error:", e));
                } catch (e) {
                    console.error("End sound failed:", e);
                }
                updateBackgroundColor(); // Update background when race ends (apply checkerboard)
                disableButtons();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(secondsLeft / 60);
        const seconds = secondsLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function checkTimeMarks() {
        const currentMinute = Math.floor(secondsLeft / 60);
        const currentSecond = secondsLeft % 60;

        // Check for minute marks (play specific minute audio when seconds hit 0)
        if (currentMinute !== lastMinutePlayed && currentSecond === 0 && currentMinute > 0) {
            try {
                const audioId = `${currentMinute}-minute`;
                console.log(`Playing audio for ${currentMinute} minute(s) left: ${audioId}`);
                const audioElement = document.getElementById(audioId);
                if (audioElement) {
                    audioElement.play().catch(e => console.error(`Audio play error for ${audioId}:`, e));
                } else {
                    console.error(`Audio element not found for ${audioId}`);
                }
            } catch (e) {
                console.error(`Error playing ${currentMinute}-minute sound:`, e);
            }
            lastMinutePlayed = currentMinute;
        }

        // Check for 30-second mark
        if (secondsLeft === 30 && !hasPlayed30Seconds) {
            try {
                console.log("Playing audio for 30 seconds left");
                document.getElementById('30-seconds').play().catch(e => console.error("Audio play error for 30-seconds:", e));
                hasPlayed30Seconds = true; // Mark as played to avoid repeats
            } catch (e) {
                console.error("30-seconds sound failed:", e);
            }
        }
    }

    function disableButtons() {
        yellowFlagBtn.disabled = true;
        redFlagBtn.disabled = true;
        restartBtn.disabled = false;
    }

    // Yellow Flag logic
    yellowFlagBtn.addEventListener('click', () => {
        isYellowFlag = !isYellowFlag;
        if (isYellowFlag) {
            try {
                document.getElementById('yellowOnSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Yellow on sound failed:", e);
            }
            yellowFlagBtn.textContent = 'Clear Yellow Flag';
        } else {
            try {
                document.getElementById('yellowOffSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Yellow off sound failed:", e);
            }
            yellowFlagBtn.textContent = 'Yellow Flag';
        }
        updateBackgroundColor(); // Update background when Yellow Flag state changes
    });

    // Red Flag logic
    redFlagBtn.addEventListener('click', () => {
        isRedFlag = !isRedFlag;
        if (isRedFlag) {
            try {
                document.getElementById('redOnSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Red on sound failed:", e);
            }
            isRunning = false;
            clearInterval(timerInterval);
            redFlagBtn.textContent = 'Clear Red Flag';
        } else {
            try {
                document.getElementById('redOffSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Red off sound failed:", e);
            }
            isRunning = true;
            startTimer();
            redFlagBtn.textContent = 'Red Flag';
        }
        updateBackgroundColor(); // Update background when Red Flag state changes
    });

    // Restart logic
    restartBtn.addEventListener('click', () => {
        clearInterval(timerInterval);
        isRunning = false;
        secondsLeft = totalSeconds;
        updateTimerDisplay();
        isYellowFlag = false;
        isRedFlag = false;
        yellowFlagBtn.textContent = 'Yellow Flag';
        redFlagBtn.textContent = 'Red Flag';
        raceTimeSelect.disabled = false; // Enable time selector on restart
        startRaceBtn.disabled = false;
        yellowFlagBtn.disabled = true;
        redFlagBtn.disabled = true;
        restartBtn.disabled = true;
        lastMinutePlayed = -1;
        hasPlayed30Seconds = false; // Reset 30-second sound flag on restart
        try {
            document.getElementById('restartSound').play().catch(e => console.error("Audio play error:", e));
        } catch (e) {
            console.error("Restart sound failed:", e);
        }
        updateBackgroundColor(); // Update background when race is restarted (remove checkerboard)
    });
</script>

</body>
</html>