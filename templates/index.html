<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RKRC Race Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>RKRC Race Control</h1>
        <div class="settings">
            <label for="raceTime">Select Race Time (minutes): </label>
            <select id="raceTime" disabled>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5" selected>5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
            <button id="startRace" disabled>Start Race</button>
        </div>
        <div class="timer" id="timer">00:00</div>
        <div class="controls">
            <button id="yellowFlag" disabled>Yellow Flag</button>
            <button id="redFlag" disabled>Red Flag</button>
            <button id="restart" disabled>Restart</button>
        </div>
    </div>

    <!-- Audio elements for different events -->
    <audio id="startSound" src="{{ url_for('static', filename='audio/start.mp3') }}" preload="auto"></audio>
    <audio id="yellowOnSound" src="{{ url_for('static', filename='audio/yellow_on.mp3') }}" preload="auto"></audio>
    <audio id="yellowOffSound" src="{{ url_for('static', filename='audio/yellow_off.mp3') }}" preload="auto"></audio>
    <audio id="redOnSound" src="{{ url_for('static', filename='audio/red_on.mp3') }}" preload="auto"></audio>
    <audio id="redOffSound" src="{{ url_for('static', filename='audio/red_off.mp3') }}" preload="auto"></audio>
    <audio id="minuteSound" src="{{ url_for('static', filename='audio/minute.mp3') }}" preload="auto"></audio>
    <audio id="endSound" src="{{ url_for('static', filename='audio/end.mp3') }}" preload="auto"></audio>
    <audio id="restartSound" src="{{ url_for('static', filename='audio/restart.mp3') }}" preload="auto"></audio>

    <script>
    const raceTimeSelect = document.getElementById('raceTime');
    const startRaceBtn = document.getElementById('startRace');
    const timerDisplay = document.getElementById('timer');
    const yellowFlagBtn = document.getElementById('yellowFlag');
    const redFlagBtn = document.getElementById('redFlag');
    const restartBtn = document.getElementById('restart');

    let totalSeconds = 0;
    let secondsLeft = 0;
    let timerInterval = null;
    let isRunning = false;
    let isYellowFlag = false;
    let isRedFlag = false;
    let lastMinutePlayed = -1;

    // Enable start button immediately for testing
    startRaceBtn.disabled = false;
    console.log("Script loaded and start button enabled!");

    // Function to update background color based on state
    function updateBackgroundColor() {
        if (isRedFlag) {
            document.body.style.backgroundColor = '#e74c3c'; // Red for Red Flag
        } else if (isYellowFlag) {
            document.body.style.backgroundColor = '#f1c40f'; // Yellow for Yellow Flag
        } else if (isRunning) {
            document.body.style.backgroundColor = '#2ecc71'; // Green for Race Running
        } else {
            document.body.style.backgroundColor = '#f0f0f0'; // Default gray when not running
        }
    }

    // Start race with random delay
    startRaceBtn.addEventListener('click', () => {
        totalSeconds = parseInt(raceTimeSelect.value) * 60;
        secondsLeft = totalSeconds;
        updateTimerDisplay();
        raceTimeSelect.disabled = true;
        startRaceBtn.disabled = true;
        yellowFlagBtn.disabled = false;
        redFlagBtn.disabled = false;
        restartBtn.disabled = false;

        const randomDelay = Math.floor(Math.random() * 5000) + 1000; // Random delay between 1-5 seconds
        setTimeout(() => {
            try {
                document.getElementById('startSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Start sound failed:", e);
            }
            isRunning = true;
            updateBackgroundColor(); // Update background when race starts
            startTimer();
        }, randomDelay);
    });

    // Timer logic
    function startTimer() {
        timerInterval = setInterval(() => {
            if (isRunning && secondsLeft > 0) {
                secondsLeft--;
                updateTimerDisplay();
                checkMinuteMark();
            } else if (secondsLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                try {
                    document.getElementById('endSound').play().catch(e => console.error("Audio play error:", e));
                } catch (e) {
                    console.error("End sound failed:", e);
                }
                updateBackgroundColor(); // Update background when race ends
                disableButtons();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(secondsLeft / 60);
        const seconds = secondsLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function checkMinuteMark() {
        const currentMinute = Math.floor(secondsLeft / 60);
        if (currentMinute !== lastMinutePlayed && secondsLeft % 60 === 0 && currentMinute > 0) {
            try {
                document.getElementById('minuteSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Minute sound failed:", e);
            }
            lastMinutePlayed = currentMinute;
        }
    }

    function disableButtons() {
        yellowFlagBtn.disabled = true;
        redFlagBtn.disabled = true;
        restartBtn.disabled = false;
    }

    // Yellow Flag logic
    yellowFlagBtn.addEventListener('click', () => {
        isYellowFlag = !isYellowFlag;
        if (isYellowFlag) {
            try {
                document.getElementById('yellowOnSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Yellow on sound failed:", e);
            }
            yellowFlagBtn.textContent = 'Clear Yellow Flag';
        } else {
            try {
                document.getElementById('yellowOffSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Yellow off sound failed:", e);
            }
            yellowFlagBtn.textContent = 'Yellow Flag';
        }
        updateBackgroundColor(); // Update background when Yellow Flag state changes
    });

    // Red Flag logic
    redFlagBtn.addEventListener('click', () => {
        isRedFlag = !isRedFlag;
        if (isRedFlag) {
            try {
                document.getElementById('redOnSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Red on sound failed:", e);
            }
            isRunning = false;
            clearInterval(timerInterval);
            redFlagBtn.textContent = 'Clear Red Flag';
        } else {
            try {
                document.getElementById('redOffSound').play().catch(e => console.error("Audio play error:", e));
            } catch (e) {
                console.error("Red off sound failed:", e);
            }
            isRunning = true;
            startTimer();
            redFlagBtn.textContent = 'Red Flag';
        }
        updateBackgroundColor(); // Update background when Red Flag state changes
    });

    // Restart logic
    restartBtn.addEventListener('click', () => {
        clearInterval(timerInterval);
        isRunning = false;
        secondsLeft = totalSeconds;
        updateTimerDisplay();
        isYellowFlag = false;
        isRedFlag = false;
        yellowFlagBtn.textContent = 'Yellow Flag';
        redFlagBtn.textContent = 'Red Flag';
        raceTimeSelect.disabled = false;
        startRaceBtn.disabled = false;
        yellowFlagBtn.disabled = true;
        redFlagBtn.disabled = true;
        restartBtn.disabled = true;
        lastMinutePlayed = -1;
        try {
            document.getElementById('restartSound').play().catch(e => console.error("Audio play error:", e));
        } catch (e) {
            console.error("Restart sound failed:", e);
        }
        updateBackgroundColor(); // Update background when race is restarted
    });
</script>
</body>
</html>